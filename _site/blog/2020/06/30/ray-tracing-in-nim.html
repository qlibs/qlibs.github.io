<!doctype html>
<html lang="en">
  <head>
  <meta name="charset" content="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="The Nim programming language is a concise, fast programming language that compiles to C, C++ and JavaScript.">
  <meta charset="utf-8">
  <link rel="icon" type="image/png" href="/assets/img/logo_bw.png" />

  
  <title>Ray tracing in Nim - Nim Blog</title>
  
  <link rel="stylesheet" href="/assets/css/pure.min.css">
  <link rel="stylesheet" href="/assets/css/pure-grids-responsive.min.css">
  <link href="https://use.fontawesome.com/releases/v5.0.2/css/all.css" rel="stylesheet">
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> -->
  
  <link rel="stylesheet" href="/assets/css/highlight/github.css">
  

  <link rel="stylesheet" href="/assets/css/google-fonts.css">
  <link rel="stylesheet" href="/assets/css/main.css?t=1721738524015683587">

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-48159761-1', 'auto');
    ga('send', 'pageview');

  </script>

  <script defer data-domain="nim-lang.org" src="https://plausible.io/js/plausible.js"></script>

  <meta name="twitter:title" content="Ray tracing in Nim">

  
  <meta name="twitter:description" content="I am convinced that if you want to start a rendering project from scratch, Nim is the best language to use.">
  <meta property="og:description" content="I am convinced that if you want to start a rendering project from scratch, Nim is the best language to use.">
  

  <meta name="twitter:site" content="@nim_lang">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://nim-lang.org/assets/img/twitter_banner.png">

  <meta property="og:title" content="Ray tracing in Nim" />
  <meta property="og:site_name" content="Nim Programming Language" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://nim-lang.org/assets/img/twitter_banner.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="1000" />
  <meta property="og:image:height" content="500" />
  <meta property="og:image:alt" content="Nim Programming Language" />
</head>

  <body class="site">
    <header>
  <nav class="pure-menu pure-menu-horizontal pure-menu-scrollable">
    <div class="nav-content">
      <a href="/" class="pure-menu-heading pure-menu-link site-logo-container">
        <img class="site-logo" src="/assets/img/logo.svg" height="28" alt="Nim">
      </a>
      <ul class="pure-menu-list">
        
        <li class="pure-menu-item">
          <a href="/blog.html"
             class="pure-menu-link current">
            Blog
          </a>
        </li>
        
        <li class="pure-menu-item">
          <a href="/features.html"
             class="pure-menu-link ">
            Features
          </a>
        </li>
        
        <li class="pure-menu-item">
          <a href="/install.html"
             class="pure-menu-link ">
            Download
          </a>
        </li>
        
        <li class="pure-menu-item">
          <a href="/documentation.html"
             class="pure-menu-link ">
            Documentation
          </a>
        </li>
        
        <li class="pure-menu-item">
          <a href="https://forum.nim-lang.org"
             class="pure-menu-link ">
            Forum
          </a>
        </li>
        
        <li class="pure-menu-item">
          <a href="/donate.html"
             class="pure-menu-link ">
            Donate
          </a>
        </li>
        
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://github.com/nim-lang/Nim">Source</a>
        </li>
      </ul>
    </div>
    <div class="menu-fade"></div>
  </nav>
</header>

    <div class="site-content post-page">
      <div class="content">
        <div class="width-reduced">
          <h1 class="post-title">
            Ray tracing in Nim
          </h1>
          <h3 class="post-meta">
            <span>
              <i class="far fa-calendar-alt" aria-hidden="true"></i>
              30 June 2020
            </span>
            
            <span>
              <i class="fa fa-user-circle" aria-hidden="true"></i>
              Mamy Ratsimbazafy (mratsim)
            </span>
            
          </h3>
          <div class="sidebarblock">
  <div class="content">
    <div class="title">Guest post</div>
    <div class="paragraph">
      This is a guest post by Mamy Ratsimbazafy (mratsim). If you would like to publish articles as a guest author on nim-lang.org then get in touch with us via
      <a href="https://twitter.com/nim_lang">Twitter</a> or <a href="https://nim-lang.org/community.html">otherwise</a>.
    </div>
  </div>
</div>

<h2 id="trace-of-radiance">Trace of Radiance</h2>

<p><a href="https://github.com/mratsim/trace-of-radiance">Trace of Radiance</a> is an implementation
of <a href="https://github.com/RayTracing/raytracing.github.io">Ray Tracing in One Weekend</a>
in the Nim programming language.</p>

<p style="text-align: center;">
  <img width="256" height="144" src="/assets/news/images/mratsim-raytracing/book1_animation.gif" />
</p>

<p>The goals are:</p>
<ul>
  <li>Learn more about ray tracing</li>
  <li>Have fun</li>
  <li>Serve as a testbed for my own multithreading runtime, <a href="https://github.com/mratsim/weave">Weave</a></li>
  <li>Showcase Nim capabilities</li>
</ul>

<p>In particular, I am convinced (and obviously biased) that if you want to start
a rendering project (ray tracing or otherwise) from scratch, Nim is the best
language to use, especially if you are focused on:</p>
<ul>
  <li>speed</li>
  <li>correctness</li>
  <li>compilation times and compile-time computation</li>
  <li>approachability and development agility</li>
</ul>

<h2 id="speed">Speed</h2>

<p>Rendering is an extremely time-consuming task.
Nim is fast, very fast, even faster than C++ from time to time.</p>

<p>Here are two benchmarks:</p>

<h3 id="1-ray-tracing-in-one-weekend">1. Ray Tracing in One Weekend</h3>

<p>From the “Ray Tracing in One Weekend” first book, using:</p>

<ul>
  <li>Nim 1.2.0 (GCC 10.1), flag <code class="language-plaintext highlighter-rouge">-d:danger</code></li>
  <li>C++ with GCC 10.1, flag <code class="language-plaintext highlighter-rouge">-O3</code></li>
</ul>

<p>On Intel Skylake-X i9-9980XE, overclocked at 4.1 GHz all-core turbo.
Compiled in x86-64 mode (SSE2 only); 384x216 image; 100 rays per pixel:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: right">Nim</th>
      <th style="text-align: right">C++</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">38.577 s</td>
      <td style="text-align: right">42.303 s</td>
    </tr>
  </tbody>
</table>

<p>The Nim sources for this benchmark can be retrieved from the
<a href="https://github.com/mratsim/trace-of-radiance/tree/v0.1.0">first release</a>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/mratsim/trace-of-radiance
<span class="nb">cd </span>trace-of-radiance
git checkout v0.1.0
nim c <span class="nt">-d</span>:danger <span class="nt">--outdir</span>:build trace_of_radiance.nim
./build/trace_of_radiance <span class="o">&gt;</span> image.ppm
</code></pre></div></div>

<h3 id="2-smallpt">2. SmallPT</h3>

<p><a href="https://www.kevinbeason.com/smallpt/">SmallPT</a> is an even smaller ray tracing project.</p>

<p style="text-align: center;">
  <img width="640" height="480" src="/assets/news/images/mratsim-raytracing/smallpt.jpg" />
</p>

<p>Benchmark from Weave multithreading runtime
<a href="https://github.com/mratsim/weave/tree/master/demos/raytracing">ray tracing demo</a>.</p>

<table>
  <thead>
    <tr>
      <th>Bench</th>
      <th style="text-align: right">Nim</th>
      <th style="text-align: right">Clang OpenMP</th>
      <th style="text-align: right">GCC 10 OpenMP</th>
      <th style="text-align: right">GCC 8 OpenMP</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Single-threaded</td>
      <td style="text-align: right">4m43.369s</td>
      <td style="text-align: right">4m51.052s</td>
      <td style="text-align: right">4m50.934s</td>
      <td style="text-align: right">4m50.648s</td>
    </tr>
    <tr>
      <td>Multithreaded</td>
      <td style="text-align: right">12.977s</td>
      <td style="text-align: right">14.428s</td>
      <td style="text-align: right">2m14.616s</td>
      <td style="text-align: right">12.244s</td>
    </tr>
    <tr>
      <td>Nested-parallel</td>
      <td style="text-align: right">12.981s</td>
      <td style="text-align: right"> </td>
      <td style="text-align: right"> </td>
      <td style="text-align: right"> </td>
    </tr>
    <tr>
      <td>Parallel speedup</td>
      <td style="text-align: right">21.83x</td>
      <td style="text-align: right">20.17x</td>
      <td style="text-align: right">2.16x</td>
      <td style="text-align: right">23.74x</td>
    </tr>
  </tbody>
</table>

<p>Single-threaded Nim is 2.7 % faster than Clang C++.<br />
Multithreaded Nim via Weave is 11.1 % faster Clang C++.</p>

<p>Note: GCC 10 has a significant OpenMP regression!</p>

<p>Here are the steps to reproduce the results.
Note that if you run the tests on a different hardware, the results might
slightly vary from the ones posted above.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/mratsim/weave
<span class="nb">cd </span>weave
nimble <span class="nb">install</span> <span class="nt">-y</span> <span class="c"># install Weave dependencies, here Synthesis, overwriting if asked.</span>

nim <span class="nt">-v</span> <span class="c"># Ensure you have nim 1.2.0 or more recent</span>

<span class="c"># Threads on (by default in this repo)</span>
nim c <span class="nt">-d</span>:danger <span class="nt">-o</span>:build/ray_threaded demos/raytracing/smallpt.nim

<span class="c"># Threads off</span>
nim c <span class="nt">-d</span>:danger <span class="nt">--threads</span>:off <span class="nt">-o</span>:build/ray_single demos/raytracing/smallpt.nim

g++ <span class="nt">-O3</span> <span class="nt">-o</span> build/ray_gcc_single demos/raytracing/smallpt.cpp
g++ <span class="nt">-O3</span> <span class="nt">-fopenmp</span> <span class="nt">-o</span> build/ray_gcc_omp demos/raytracing/smallpt.cpp

clang++ <span class="nt">-O3</span> <span class="nt">-o</span> build/ray_clang_single demos/raytracing/smallpt.cpp
clang++ <span class="nt">-O3</span> <span class="nt">-fopenmp</span> <span class="nt">-o</span> build/ray_clang_omp demos/raytracing/smallpt.cpp
</code></pre></div></div>

<p>Then run for 300 samples with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>build/ray_threaded 300
# ...
build/ray_clang_omp 300
</code></pre></div></div>

<h2 id="correctness">Correctness</h2>

<h3 id="distinct-types-and-modeling-physical-units">Distinct types and modeling physical units</h3>

<p>Nim is one of the few languages that can properly model physical units
and enforce proper usage of those units at compile-time.
For example, a vector and a unit vector have the same representation but are
distinct types.
Unit vectors are auto-convertible to vectors when passed to a function:</p>

<pre><code class="language-Nim">type
  Vec3* = object
    x*, y*, z*: float64

  UnitVector* {.borrow:`.`.} = distinct Vec3
    # The `.` annotation ensures that field access is possible

converter toVec3*(uv: UnitVector): Vec3 {.inline.} =
  ## UnitVector are seamlessly convertible to Vec3 (but not the other way around)
  Vec3(uv)
</code></pre>

<p><code class="language-plaintext highlighter-rouge">Point3</code> uses the same internal representation as <code class="language-plaintext highlighter-rouge">Vec3</code> and can borrow (share)
the implementation of common operators (i.e. no code-size impact):</p>

<pre><code class="language-Nim">type Point3* {.borrow: `.`.} = distinct Vec3
  # The `.` annotation ensures that field access is possible

func `*=`*(a: var Point3, scalar: float64) {.borrow.}
func `*`*(a: Point3, scalar: float64): Point3 {.borrow.}
func `*`*(scalar: float64, a: Point3): Point3 {.borrow.}
</code></pre>

<p>Also:</p>
<ul>
  <li>subtracting 2 points gives a vector,</li>
  <li>adding a vector to a point gives a point,</li>
  <li>adding 2 points is disallowed, with an nice custom error message instead of the compiler default errors.</li>
</ul>

<pre><code class="language-Nim">func `-`*(a, b: Point3): Vec3 {.inline.}=
  ## Subtracting one point from another gives a vector
  result.x = a.x - b.x
  result.y = a.y - b.y
  result.z = a.z - b.z

func `+`*(p: Point3, v: Vec3): Point3 {.inline.}=
  ## Adding a vector to a point results in a point
  Point3(Vec3(p) + v)

func `-`*(p: Point3, v: Vec3): Point3 {.inline.}=
  ## Subtracting a vector from a point results in a point
  Point3(Vec3(p) - v)

func `+`*(a, b: Point3): Point3 {.error: "Adding 2 Point3 doesn't make physical sense".}
</code></pre>

<p>I also have two types for colors and their attenuations (as a percentage), so you
cannot multiply colors:</p>

<pre><code class="language-Nim">type Color* {.borrow: `.`.} = distinct Vec3

func `*`*(a, b: Color): Color {.error: "Multiplying 2 Colors doesn't make physical sense".}

type Attenuation* {.borrow: `.`.} = distinct Color

func `*=`*(a: var Attenuation, b: Attenuation) {.inline.} =
  # Multiply a color by a per-channel attenuation factor
  a.x *= b.x
  a.y *= b.y
  a.z *= b.z

func `*`*(a, b: Attenuation): Attenuation {.inline.} =
  # Multiply a color by a per-channel attenuation factor
  result.x = a.x * b.x
  result.y = a.y * b.y
  result.z = a.z * b.z

func `*=`*(a: var Color, b: Attenuation) {.inline.} =
  # Multiply a color by a per-channel attenuation factor
  a.x *= b.x
  a.y *= b.y
  a.z *= b.z
</code></pre>

<p>Last but not least, ensure you don’t mix and match degrees and radians,
with auto-conversion of radians to float (and degree would stay at a higher level):</p>

<pre><code class="language-Nim">type
  Degrees* = distinct float64
  Radians* = distinct float64

template degToRad*(deg: Degrees): Radians =
  Radians(degToRad(float64(deg)))

template radToDeg*(rad: Radians): Degrees =
  Degrees(radToDeg(float64(rad)))

# For now we don't create our full safe unit library
# with proper cos/sin/tan radians enforcing
# and auto-convert to float
converter toF64*(rad: Radians): float64 {.inline.} =
  float64(rad)
</code></pre>

<h3 id="tracking-mutability">Tracking mutability</h3>

<p>When using value types (stack objects, seq and strings), Nim requires an
explicit <code class="language-plaintext highlighter-rouge">var</code> when passing parameters or assigning to a variable for
a parameter to be mutable.</p>

<p>This makes it clear what can or can’t move under your feet.</p>

<p>Furthermore, C and C++ developers might be interested to know that
when passing a large object (over 12 bytes on 32-bit and 24 bytes on 64-bit platforms),
Nim does the Right Thing™ and will pass by reference by default
(you can override that on a per-type basis to always pass-by-copy or always by reference).
This means that function signatures are motivated by mutability concerns and
uncluttered from performance (and performance is great, as proven by the benchmarks).</p>

<h3 id="tracking-side-effects">Tracking side-effects</h3>

<p>Nim functions can be declared <code class="language-plaintext highlighter-rouge">proc</code> or <code class="language-plaintext highlighter-rouge">func</code>.</p>

<p>A <code class="language-plaintext highlighter-rouge">func</code> enforces the absence of side-effects or the code will not compile.
Some examples of side-effects:</p>
<ul>
  <li>(non-deterministic) random functions</li>
  <li>accessing a global variable</li>
  <li>multithreading</li>
  <li>IO</li>
</ul>

<p>If you have a Heisenbug, it’s likely not in a side-effect free function
(unless you corrupt memory).</p>

<p>This is particularly suited to physics and ray tracing computational kernels
as physics equations are side-effect free.</p>

<h2 id="compilation-times--meta-programming">Compilation times &amp; Meta-programming</h2>

<p>Despite all its features, Nim compiles extremely fast with both C and C++ targets.
In particular template metaprogramming has a very low compilation-time cost.</p>

<p>Nim is the language with the widest support for compile-time metaprogramming,
including dependently-typed languages.</p>

<p>This is supported by a fast VM that gives Nim the speed of Python at
compile-time and is used for:</p>
<ul>
  <li>writing domain specific languages
    <ul>
      <li>state machine generators</li>
      <li>seamless multidimensional arrays uses, including Einstein summation</li>
      <li>shader generators</li>
      <li>SIMD kernel generators</li>
      <li>…</li>
    </ul>
  </li>
  <li>compile-time precomputations</li>
  <li>buffers, vectors, matrices parametrized by integer generics</li>
</ul>

<h2 id="c-and-c-interop">C and C++ interop</h2>

<p>Nim can compile to both C and C++ and seamlessly call libraries written in either language.
It can even use CUDA with a bit of configuration to call <code class="language-plaintext highlighter-rouge">nvcc</code>.</p>

<p>For example, bindings to SFML, from the Nim website features:</p>

<p style="text-align: center;">
  <img width="715" height="721" src="/assets/news/images/mratsim-raytracing/sfml.png" />
</p>

<h2 id="approachability-productivity--development-agility">Approachability, productivity &amp; development agility</h2>

<p>While Nim offers many advanced features, it does not force you to swim or drown
on first approach.<br />
Actually many have reported that Nim felt like a compiled scripting language.</p>

<h2 id="caveats">Caveats</h2>

<p>Not all is ponies and rainbows. Nim’s main issue is that it is a very young language
with a small ecosystem of supported libraries.
That said, you can reuse the C and C++ ecosystem (and Javascript as well, since
Nim can also compile to it).
As an example, Trace of Radiance supports video output via MP4 since v0.2.0 via a
<a href="https://github.com/mratsim/trace-of-radiance/blob/v0.2.0/trace_of_radiance/io/mp4.nim#L1-L60">simple 60-line wrapper</a>
of a header-only C library.</p>

        </div>
      </div>
    </div>
    <footer>
  <section class="content">
    <div class="pure-g">
      <div class="copyright pure-u-2-3">
        <p>
          Unless otherwise stated, the content of this page is
          licensed under the
          <a href="https://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0</a>
          license.
          Code displayed on this website is MIT licensed.
        </p>
        <p>
          This website is available on
          <a href="https://github.com/nim-lang/website">GitHub</a>
          and contributions are welcome.
          Original website design by
          <a href="https://github.com/dom96">Dominik Picheta</a> and
          <a href="https://github.com/Calinou">Hugo Locurcio</a>.
          Logo by <a href="https://github.com/josephwecker">Joseph Wecker</a>.
        </p>
      </div>
      <div class="pure-u-1-3 right-center">
        <a href="https://m.do.co/c/637ab907c7f4"><img src="/assets/img/do.png"/></a>
      </div>
    </div>
  </section>

</footer>
<script>
    (function(){
      function setTracking(a) {
        var url = a.href;
        a.onclick = function() {
          if (typeof(ga) !== "undefined") {
            ga('send', 'event', 'outbound', 'click', url, {
              'transport': 'beacon',
              'hitCallback': function(){document.location = url;}
            });
          }
        };
      }

      var a = document.getElementsByTagName("a");
      for (var i = 0; i < a.length; ++i) {
        if (a[i].hostname != location.hostname &&
            a[i].getAttribute("target") !== "_blank"
        ) {
          setTracking(a[i])
        }
      }
    })();
</script>

  </div>
  </body>
</html>
