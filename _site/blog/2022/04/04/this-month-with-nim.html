<!doctype html>
<html lang="en">
  <head>
  <meta name="charset" content="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="The Nim programming language is a concise, fast programming language that compiles to C, C++ and JavaScript.">
  <meta charset="utf-8">
  <link rel="icon" type="image/png" href="/assets/img/logo_bw.png" />

  
  <title>This Month with Nim: Feburary and March 2022 - Nim Blog</title>
  
  <link rel="stylesheet" href="/assets/css/pure.min.css">
  <link rel="stylesheet" href="/assets/css/pure-grids-responsive.min.css">
  <link href="https://use.fontawesome.com/releases/v5.0.2/css/all.css" rel="stylesheet">
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> -->
  
  <link rel="stylesheet" href="/assets/css/highlight/github.css">
  

  <link rel="stylesheet" href="/assets/css/google-fonts.css">
  <link rel="stylesheet" href="/assets/css/main.css?t=1721738524015683587">

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-48159761-1', 'auto');
    ga('send', 'pageview');

  </script>

  <script defer data-domain="nim-lang.org" src="https://plausible.io/js/plausible.js"></script>

  <meta name="twitter:title" content="This Month with Nim: Feburary and March 2022">

  
  <meta name="twitter:description" content="Automatic C bindings, a Declarative GTK, Typesafe-ish macros, and a GameCube Emulator">
  <meta property="og:description" content="Automatic C bindings, a Declarative GTK, Typesafe-ish macros, and a GameCube Emulator">
  

  <meta name="twitter:site" content="@nim_lang">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://nim-lang.org/assets/img/twitter_banner.png">

  <meta property="og:title" content="This Month with Nim: Feburary and March 2022" />
  <meta property="og:site_name" content="Nim Programming Language" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://nim-lang.org/assets/img/twitter_banner.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="1000" />
  <meta property="og:image:height" content="500" />
  <meta property="og:image:alt" content="Nim Programming Language" />
</head>

  <body class="site">
    <header>
  <nav class="pure-menu pure-menu-horizontal pure-menu-scrollable">
    <div class="nav-content">
      <a href="/" class="pure-menu-heading pure-menu-link site-logo-container">
        <img class="site-logo" src="/assets/img/logo.svg" height="28" alt="Nim">
      </a>
      <ul class="pure-menu-list">
        
        <li class="pure-menu-item">
          <a href="/blog.html"
             class="pure-menu-link current">
            Blog
          </a>
        </li>
        
        <li class="pure-menu-item">
          <a href="/features.html"
             class="pure-menu-link ">
            Features
          </a>
        </li>
        
        <li class="pure-menu-item">
          <a href="/install.html"
             class="pure-menu-link ">
            Download
          </a>
        </li>
        
        <li class="pure-menu-item">
          <a href="/documentation.html"
             class="pure-menu-link ">
            Documentation
          </a>
        </li>
        
        <li class="pure-menu-item">
          <a href="https://forum.nim-lang.org"
             class="pure-menu-link ">
            Forum
          </a>
        </li>
        
        <li class="pure-menu-item">
          <a href="/donate.html"
             class="pure-menu-link ">
            Donate
          </a>
        </li>
        
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://github.com/nim-lang/Nim">Source</a>
        </li>
      </ul>
    </div>
    <div class="menu-fade"></div>
  </nav>
</header>

    <div class="site-content post-page">
      <div class="content">
        <div class="width-reduced">
          <h1 class="post-title">
            This Month with Nim: Feburary and March 2022
          </h1>
          <h3 class="post-meta">
            <span>
              <i class="far fa-calendar-alt" aria-hidden="true"></i>
              04 April 2022
            </span>
            
            <span>
              <i class="fa fa-user-circle" aria-hidden="true"></i>
              The Nim Community
            </span>
            
          </h3>
          <h2 id="futhark"><a href="https://github.com/PMunch/futhark">Futhark</a></h2>

<h4 id="author-pmunch">Author: <a href="https://github.com/PMunch">PMunch</a></h4>

<p>Have your eyes set on the perfect C library for your project?
Canâ€™t find a wrapper for it in Nim?
Look no further!</p>

<p>Futhark aims to allow you to simply import C header files directly into Nim,
and allow you to use them like you would from C without any manual intervention.
It is still in an alpha state,
but it can already wrap many complex header files without any rewrites or pre-processing.</p>

<div class="language-nim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="n">futhark</span>

<span class="c"># Tell futhark where to find the C libraries you will compile with, and what</span>
<span class="c"># header files you wish to import.</span>
<span class="n">importc</span><span class="p">:</span>
  <span class="n">sysPath</span> <span class="s">"/usr/lib/clang/12.0.1/include"</span>
  <span class="n">path</span> <span class="s">"../stb"</span>
  <span class="n">define</span> <span class="n">STB_IMAGE_IMPLEMENTATION</span>
  <span class="s">"stb_image.h"</span>

<span class="c"># Tell Nim how to compile against the library. If you have a dynamic library</span>
<span class="c"># this would simply be a `--passL:"-l&lt;library name&gt;`</span>
<span class="k">static</span><span class="p">:</span>
  <span class="n">writeFile</span><span class="p">(</span><span class="s">"test.c"</span><span class="p">,</span> <span class="s">"""
  #define STB_IMAGE_IMPLEMENTATION
  #include "../stb/stb_image.h"
  """</span><span class="p">)</span>
<span class="p">{.</span><span class="n">compile</span><span class="p">:</span> <span class="s">"test.c"</span><span class="p">.}</span>

<span class="c"># Use the library just like you would in C!</span>
<span class="k">var</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">channels</span><span class="p">:</span> <span class="n">cint</span>

<span class="k">var</span> <span class="n">image</span> <span class="o">=</span> <span class="n">stbi_load</span><span class="p">(</span><span class="s">"futhark.png"</span><span class="p">,</span> <span class="n">width</span><span class="p">.</span><span class="k">addr</span><span class="p">,</span> <span class="n">height</span><span class="p">.</span><span class="k">addr</span><span class="p">,</span> <span class="n">channels</span><span class="p">.</span><span class="k">addr</span><span class="p">,</span> <span class="n">STBI_default</span><span class="p">.</span><span class="n">cint</span><span class="p">)</span>
<span class="k">if</span> <span class="n">image</span> <span class="o">==</span> <span class="k">nil</span><span class="p">:</span>
  <span class="n">echo</span> <span class="s">"Error in loading the image"</span>
  <span class="n">quit</span> <span class="mi">1</span>

<span class="n">echo</span> <span class="s">"Loaded image with a width of "</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="s">", a height of "</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="s">" and "</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="s">" channels"</span>
<span class="n">stbi_image_free</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</code></pre></div></div>

<p>Install the newest 0.5.0 version now with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nimble install futhark
</code></pre></div></div>

<h2 id="owlkettle"><a href="https://github.com/can-lehmann/owlkettle">OwlKettle</a></h2>

<h4 id="author-can-lehmann">Author: <a href="https://github.com/can-lehmann">Can Lehmann</a></h4>

<p>OwlKettle is a declarative user interface framework based on GTK. It brings the declarative GUI paradigm you know from many web frameworks to the Linux desktop.</p>

<p>Letâ€™s look at an example application:</p>

<div class="language-nim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="n">owlkettle</span>

<span class="n">viewable</span> <span class="n">App</span><span class="p">:</span>
  <span class="n">counter</span><span class="p">:</span> <span class="kt">int</span>

<span class="k">method</span> <span class="n">view</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">AppState</span><span class="p">):</span> <span class="n">Widget</span> <span class="o">=</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">gui</span><span class="p">:</span>
    <span class="n">Window</span><span class="p">:</span>
      <span class="n">title</span> <span class="o">=</span> <span class="s">"Counter"</span>
      <span class="n">default_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
      <span class="n">border_width</span> <span class="o">=</span> <span class="mi">12</span>

      <span class="n">Box</span><span class="p">(</span><span class="n">orient</span> <span class="o">=</span> <span class="n">OrientX</span><span class="p">,</span> <span class="n">spacing</span> <span class="o">=</span> <span class="mi">6</span><span class="p">):</span>
        <span class="n">Label</span><span class="p">(</span><span class="n">text</span> <span class="o">=</span> <span class="o">$</span><span class="n">app</span><span class="p">.</span><span class="n">counter</span><span class="p">)</span>
        <span class="n">Button</span><span class="p">:</span>
          <span class="n">text</span> <span class="o">=</span> <span class="s">"+"</span>
          <span class="n">style</span> <span class="o">=</span> <span class="p">{</span><span class="n">ButtonSuggested</span><span class="p">}</span>
          <span class="k">proc </span><span class="nf">clicked</span><span class="p">()</span> <span class="o">=</span>
            <span class="n">app</span><span class="p">.</span><span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">brew</span><span class="p">(</span><span class="n">gui</span><span class="p">(</span><span class="n">App</span><span class="p">()))</span>
</code></pre></div></div>

<p>This code results in the following interactive application:</p>

<p><img src="https://github.com/can-lehmann/owlkettle/blob/main/docs/assets/introduction.png?raw=true" alt="An example application" /></p>

<p>If interested, check out <a href="https://github.com/can-lehmann/owlkettle/tree/main/examples">more examples</a>.</p>

<h2 id="micros"><a href="https://github.com/beef331/micros">Micros</a></h2>

<h4 id="author-jason-beetham">Author: <a href="https://github.com/beef331">Jason Beetham</a></h4>

<p>Micros is an early state typesafe API on top of Nimâ€™s <code class="language-plaintext highlighter-rouge">NimNode</code>s.
It provides utility procedures for these types to enable simpler and more readable APIs.</p>

<p>Want to iterate a procedureâ€™s parameters?</p>

<p>Just do:</p>
<div class="language-nim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">idefs</span> <span class="ow">in</span> <span class="n">myProcDef</span><span class="p">.</span><span class="n">routine</span><span class="p">.</span><span class="n">params</span><span class="p">:</span>
  <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">idefs</span><span class="p">.</span><span class="n">names</span><span class="p">:</span>
    <span class="n">echo</span> <span class="n">name</span><span class="p">.</span><span class="n">NimNode</span>
</code></pre></div></div>

<p>Want to add a generic parameter to an object definition?</p>

<p>Just do:</p>
<div class="language-nim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">myTypeDef</span><span class="p">.</span><span class="n">objectDef</span><span class="p">.</span><span class="n">addGeneric</span> <span class="n">identDef</span><span class="p">(</span><span class="s">"Y"</span><span class="p">,</span> <span class="kt">int</span> <span class="ow">or</span> <span class="kt">string</span> <span class="ow">or</span> <span class="kt">float</span><span class="p">)</span>
</code></pre></div></div>

<p>It is pretty early so there are not many docs,
but I have started migrating my other macro libraries to it,
as itâ€™s more maintainable and easier to understand.</p>

<p>If wanting to see more examples I have a bunch of <a href="https://github.com/beef331/micros/tree/master/tests">tests</a>.</p>

<h2 id="hocuspocube"><a href="https://github.com/RSDuck/hocuspocube">hocuspocube</a></h2>

<h4 id="authors-rsduck--doofenstein">Authors: <a href="https://github.com/RSDuck">RSDuck</a> / doofenstein</h4>

<p>Hocuspocube is a Nintendo GameCube emulator.</p>

<p>At this stage itâ€™s able to boot the IPL (initial program loader,
which loads games from DVDs and also displays the famous rolling cube animation)
as well as several commercial games.
For faster execution it features an IR based JIT recompiler,
so that both the PowerPC core (Gekko) and the DSP can share a backend for code generation.
For assembling my own assembler, <a href="https://github.com/RSDuck/catnip">catnip</a> is used.</p>

<p>The go-to language for emulators is usually C++, mainly for performance reasons.
But I see Nim fitting this requirement just as well,
while avoiding many of the hassles C++ has
(and also just being my favourite programming language overall).</p>

<p>I want to highlight some macros in the codebase:</p>

<h3 id="the-instruction-decoding-macro">The instruction decoding macro</h3>

<p>Fast instruction decoding in software is normally all about creating the smallest possible LUT/case statement,
where some bits of the instruction are entered which then dispatches it to the appropriate handler.
As you can probably imagine, this is a recipe for giant seas of constants like
<a href="https://github.com/Arisotura/melonDS/blob/master/src/ARM_InstrTable.h">this</a>.</p>

<p>It is not the worst thing in the world,
but itâ€™s also something you can avoid with Nim!
With the macro, all we have to define are those pretty instruction patterns:</p>

<div class="language-nim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="n">PpcPatterns</span><span class="o">*</span> <span class="o">=</span>
    <span class="p">(</span><span class="k">block</span><span class="p">:</span>
        <span class="k">var</span> <span class="n">patterns</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">)</span><span class="o">]</span>

        <span class="c"># Integer Arithmetic</span>
        <span class="k">template</span> <span class="n">intArith</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">num</span><span class="p">:</span> <span class="kt">int</span><span class="p">,</span> <span class="n">oe</span> <span class="o">=</span> <span class="kp">true</span><span class="p">):</span> <span class="n">untyped</span> <span class="o">=</span>
            <span class="n">patterns</span><span class="p">.</span><span class="n">add</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">"011111dddddaaaaabbbbb"</span> <span class="o">&amp;</span> <span class="p">(</span><span class="k">if</span> <span class="n">oe</span><span class="p">:</span> <span class="s">"o"</span> <span class="k">else</span><span class="p">:</span> <span class="s">"0"</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">toBin</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="s">"r"</span><span class="p">)</span>
        <span class="k">template</span> <span class="n">intArithImm</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">num</span><span class="p">:</span> <span class="kt">int</span><span class="p">):</span> <span class="n">untyped</span> <span class="o">=</span>
            <span class="n">patterns</span><span class="p">.</span><span class="n">add</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">toBin</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="s">"dddddaaaaaiiiiiiiiiiiiiiii"</span><span class="p">)</span>
        <span class="n">intArith</span>    <span class="s">"addx"</span><span class="p">,</span>         <span class="mi">266</span>
        <span class="n">intArith</span>    <span class="s">"addcx"</span><span class="p">,</span>        <span class="mi">10</span>
        <span class="n">intArith</span>    <span class="s">"addex"</span><span class="p">,</span>        <span class="mi">138</span>
        <span class="n">intArithImm</span> <span class="s">"addi"</span><span class="p">,</span>         <span class="mi">14</span>
        <span class="n">intArithImm</span> <span class="s">"addic"</span><span class="p">,</span>        <span class="mi">12</span>
        <span class="n">intArithImm</span> <span class="s">"addicdot"</span><span class="p">,</span>     <span class="mi">13</span>
        <span class="c">#....</span>
        <span class="n">patterns</span><span class="p">)</span>

<span class="k">macro</span> <span class="n">dispatchPpc</span><span class="o">*[</span><span class="n">T</span><span class="o">]</span><span class="p">(</span><span class="n">instr</span><span class="p">:</span> <span class="n">uint32</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="k">var</span> <span class="n">T</span><span class="p">,</span> <span class="n">undefinedInstr</span><span class="p">:</span> <span class="k">proc</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="k">var</span> <span class="n">T</span><span class="p">,</span> <span class="n">instr</span><span class="p">:</span> <span class="n">uint32</span><span class="p">))</span> <span class="o">=</span>
    <span class="n">generateDecoder</span><span class="o">[</span><span class="mf">26</span><span class="p">..</span><span class="mi">31</span><span class="p">,</span> <span class="mf">1</span><span class="p">..</span><span class="mi">10</span><span class="o">]</span><span class="p">(</span><span class="n">PpcPatterns</span><span class="p">,</span> <span class="n">initTable</span><span class="o">[</span><span class="kt">string</span><span class="p">,</span> <span class="kt">seq</span><span class="o">[</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="n">uint32</span><span class="p">)</span><span class="o">]]</span><span class="p">(),</span> <span class="mi">32</span><span class="p">,</span> <span class="n">instr</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">undefinedInstr</span><span class="p">)</span>
</code></pre></div></div>

<p>As a bonus, the macro also does the decoding of the instruction fields for us based on the patterns in the field!</p>

<h3 id="hardware-register-macro">Hardware register macro</h3>

<p>What glues together processors and other hardware is for the most part hardware registers,
which can be written to and read from.
While at first this seems like something pretty simple:
just use a case statement with all the addresses.
But it gets more complicated because a processor can read and write with multiple sizes
which can end up accessing multiple registers at the same time or only a partial register
(or in some combinations the system also just locks up).</p>

<p>Additionally, the PowerPC processor in the GameCube is big endian,
which makes things even more complicated
(theoretically itâ€™s possible to switch it to little endian, though nobody ever did that).</p>

<p>The <code class="language-plaintext highlighter-rouge">ioBlock</code> macro handles all of this:</p>

<div class="language-nim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ioBlock</span> <span class="n">vi</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">:</span>
<span class="k">of</span> <span class="n">vtr</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">read</span><span class="p">:</span> <span class="n">uint16</span> <span class="n">vtr</span>
    <span class="n">write</span><span class="p">:</span>
        <span class="c"># ...</span>
<span class="k">of</span> <span class="n">dcr</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">read</span><span class="p">:</span> <span class="n">uint16</span> <span class="n">dcr</span>
    <span class="n">write</span><span class="p">:</span>
        <span class="n">dcr</span><span class="p">.</span><span class="n">mutable</span> <span class="o">=</span> <span class="n">val</span>
        <span class="c"># ...</span>
<span class="k">of</span> <span class="n">htr0</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span>
    <span class="n">read</span><span class="p">:</span> <span class="n">uint32</span> <span class="n">htr0</span>
    <span class="n">write</span><span class="p">:</span>
            <span class="c"># ....</span>
            <span class="n">htr0</span><span class="p">.</span><span class="n">mutable</span> <span class="o">=</span> <span class="n">val</span>
</code></pre></div></div>

<p>In this case Iâ€™m not saying that this is the only good solution,
but I think this one is pretty neat (Iâ€™ve seen this also solved relatively cleanly with a table of function pointers).</p>

<p>It also runs as a homebrew application Nintendo Switch,
albeit magnitudes slower than on PC (where it doesnâ€™t reach full speed yet either).
Though the JIT recompiler at the moment only targets x64.</p>

<p>Many parts are still very much temporary,
so if you decide to look at the source code,
donâ€™t be scared when you see the <code class="language-plaintext highlighter-rouge">glReadPixels</code> ðŸ˜„.
At the moment my main focus is currently to optimise it far enough to reach at least full speed,
otherwise implementing more hardware features and then testing them would just be just a slog.</p>

<hr />

<h2 id="want-to-see-your-project-here-next-month">Want to see your project here next month?</h2>

<p><a href="https://github.com/beef331/website#adding-your-project-to-month-with-nim">Follow this</a>
to add your project to the next monthâ€™s blog post.</p>

        </div>
      </div>
    </div>
    <footer>
  <section class="content">
    <div class="pure-g">
      <div class="copyright pure-u-2-3">
        <p>
          Unless otherwise stated, the content of this page is
          licensed under the
          <a href="https://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0</a>
          license.
          Code displayed on this website is MIT licensed.
        </p>
        <p>
          This website is available on
          <a href="https://github.com/nim-lang/website">GitHub</a>
          and contributions are welcome.
          Original website design by
          <a href="https://github.com/dom96">Dominik Picheta</a> and
          <a href="https://github.com/Calinou">Hugo Locurcio</a>.
          Logo by <a href="https://github.com/josephwecker">Joseph Wecker</a>.
        </p>
      </div>
      <div class="pure-u-1-3 right-center">
        <a href="https://m.do.co/c/637ab907c7f4"><img src="/assets/img/do.png"/></a>
      </div>
    </div>
  </section>

</footer>
<script>
    (function(){
      function setTracking(a) {
        var url = a.href;
        a.onclick = function() {
          if (typeof(ga) !== "undefined") {
            ga('send', 'event', 'outbound', 'click', url, {
              'transport': 'beacon',
              'hitCallback': function(){document.location = url;}
            });
          }
        };
      }

      var a = document.getElementsByTagName("a");
      for (var i = 0; i < a.length; ++i) {
        if (a[i].hostname != location.hostname &&
            a[i].getAttribute("target") !== "_blank"
        ) {
          setTracking(a[i])
        }
      }
    })();
</script>

  </div>
  </body>
</html>
